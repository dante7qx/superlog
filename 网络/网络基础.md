## 网络

### 一. 名词

**internet**：互联网，由多个计算机网络互联而成的网络。

**Internet**：因特网，特定的计算机网络。

**ISP**：因特网服务提供商(Interne Service Provider)，例如电信、移动，他们向因特网管理机构申请海量IP。

**IXP**：因特网交换点(Internet exchange point)。

**p2p**：peer-to-peer。两个主机都运行了对等连接软件（P2P软件），进行平等的、对等连接通信。

**路由器**：一种具有多个输入端口和多个输出端口的专用计算机。实现分组交换的关键构件。使用存储转发技术。

![路由器结构](/Users/dante/Documents/Technique/且行且记/网络/路由器结构.png)

**存储转发**：在发送报文之前，先将较长的报文划分为一个个小的等长数据段，每个**数据段**前面加上**Header**，这样就构成了分组 **Packet**，也成为**包**。包是网络中传输的基本单元。

- 报文（Message）：要发送的整体数据。
- Header：包头，包含诸如目标地址、源地址等控制信息。
- 分组转发：路由器收到一个包，先暂存，然后根据Header去查找转发表，将包转发到下一个路由器。

**带宽**：单位时间内网络从一点到另一点所能通过的 “最高数据率”。

**吞吐量**：单位时间内通过某个网络（或信号、接口）的数据量。100Mb/s的以太网，典型吞吐量70Mb/s。

**延迟**：数据从网络一端到另一端所需要的时间。**总延迟 = 发送延迟 + 传播延迟 + 处理延迟 + 排队延迟**。

- ***发送延迟**：主机或路由器发送数据帧所需时间，也称为 **传输延迟 = 数据帧长度(b) / 发送速率(b/s)**。

- **传播延迟**：电磁波在信道上传播一定距离所需时间， **信道长度(m) / 传播速率(m/s)**。其中光纤的传播速率是

  ​		    2 * 10⁵ km/s。

- **处理延迟：**主机或路由器进行分组转发所花费的时间。

- **排队延迟**：分组进入路由器后，先在输入队列排队等待处理，确定了转发接口后，在输出队列中等待转发。

- **RTT:** 往返时间(Round-Trip Time)，从发送方发送数据开始，到发送方收到接收方的确认。

- **利用率**：信道利用率和网络利用率，利用率过高会产生非常大的延迟。

- **上行带宽**：用户到**ISP**的带宽。

- **下行带宽：** **ISP**到用户的带宽。

- **TTL：**数据报在网络中的寿命，单位是跳数。

### 二. 网络协议

![网络结构](/Users/dante/Documents/Technique/且行且记/网络/网络结构.png)

- **应用层**：应用进程根据应用层协议（例如：http、smtp等），相互发送报文。
- **传输层**：为应用进程的通信提供传输服务。传送报文到下层（网络层），接受下层数据返回到应用层。
  - TCP：数据传输协议，面向连接的，基本传输单位是报文段（segment）。
  - UDP：用户数据报协议，无连接的数据传输服务，基本传输单位是用户数据报。
- **网络层：**提供通信服务，使用IP协议。接受传输层的报文段，封装成**包(Packet)**（或IP数据报），负责查找路由进行传输。需要使用设备路由器。
- **数据链路层：**（data link layer），接受网络层的 IP数据报，组装成帧（framing），每一帧由 数据+控制信息  组成。收到一个帧后，抽取数据部分，传给网络层。
- **物理层：**连接传输媒体传输bit流数据。传输数据的单位是bit，将数据交由硬件设备（光缆、无线信道等）进行处理。

#### 1. 物理层

- 集线器（hub）：主要功能是对接收到的信号进行再生整形放大，以扩大网络的传输距离，同时把所有节点集中在以它为中心的节点上。即多端口转发器，网络中某条线路产生了故障，并不影响其它线路的工作。

  ![集线器 - hub](/Users/dante/Documents/Technique/且行且记/网络/集线器 - hub.png)

#### 2. 数据链路层

**物理链路**：一个节点到相邻节点的一段物理线路（有线或无线）

**逻辑链路**：物理线路 + 通信协议 + 实现软/硬件（例：网络适配器）

**信道类型：**点对点信道、广播信道。

**点对点协议**：封装成帧、透明传输、差错检测。

![dll-p2p-1](/Users/dante/Documents/Technique/且行且记/网络/dll-p2p-1.png)

- **封装成帧**：将IP数据报的前后添加Header和Tailer，构成一个帧。

  ![frame](/Users/dante/Documents/Technique/且行且记/网络/frame.png)

- **透明传输：**无论IP数据包是什么内容，都可以构成帧进行传输。（帧的开始、结束符是特定的控制字符，不能在数据中出现）。

  ![帧-透明传输](/Users/dante/Documents/Technique/且行且记/网络/帧-透明传输.png)

- PPPoE：PPP over Ethernet 宽带上网的主机使用的链路层协议。将PPP帧在封装成 Ethernet帧。

  ![PPP-帧格式](/Users/dante/Documents/Technique/且行且记/网络/PPP-帧格式.png)

- **适配器：**PC 和 LAN通过适配器进行通信，含有处理器和存储器（RAM 和 ROM）。计算机发送IP数据报，由协议栈将IP数据报向下交给适配器，组装成帧后发送到局域网。硬件地址也成为**MAC地址**（适配器地址）。

  ![适配器](/Users/dante/Documents/Technique/且行且记/网络/适配器.png)

  适配器的过滤功能：

  - 单播帧(unicast): 收到的帧的MAC地址与本站的硬件地址相同。
  - 广播帧(broadcast): 发送给本局域网上所有站点的帧。
  - 多播帧(multicast): 发送给本局域网上一部分的帧。

- **网桥**（桥接器）：用来连接不同的网段，简单的网桥有两个端口，分别有一条独立的交换信道，不是共享一条背板总线，可隔离冲突区。每个端口与一个网段互联，可扩展局域网。

  ​	连接两个局域网的一种存储/转发设备，它能将一个大的LAN分割为多个网段，或将两个以上的LAN互联为一个逻辑LAN，使LAN上的所有用户都可访问服务器。后来，网桥被具有更多端口、同时也可隔离冲突域的交换机（Switch）所取代。

  ![网桥](/Users/dante/Documents/Technique/且行且记/网络/网桥.png)

- **交换机（switch）：**一种基于MAC（网卡的硬件地址）识别，能完成封装转发数据包功能的网络设备。交换机交换机拥有一条很高带宽的背部总线和内部交换矩阵，可以“学习”MAC地址，并把其存放在内部地址表中，通过在数据帧的发送者和目标接收者之间建立临时的交换路径，使数据帧直接由源地址到达目的地址。

#### 3. 网络层

​	网络层向上（运输层）只提供简单的、无连接的、尽最大努力交付（传输错误）的数据报服务。

##### a. 协议

​	![网际协议](/Users/dante/Documents/Technique/且行且记/网络/网际协议.png)

- IP协议

  ![IP网](/Users/dante/Documents/Technique/且行且记/网络/IP网.png)

  所有的网络之间使用**IP协议**进行互联，构成一个大的网络。

- 地址解析协议 **ARP**（Address Resolution Protocol）

  ​	数据链路层传输的是**MAC帧**，**ARP** 协议通过在主机 ARP 高速缓存中存放一个从IP到硬件地址的映射表，此表动态更新。

- 网际控制报文协议 **ICMP**（Internet Control Message Protocol）

  ICMP 允许主机或路由报告差错情况和提供有关异常情况的报告，ICMP报文封装在IP数据报中，作为数据部分。

  - 差错报告报文

  ​

  - 询问报文

    ping，分组网间探测（Packet InterNet Groper），用来测试两个主机之间的连通性。使用 ICMP 的回送请求和回送回答报文，即由主机或路由器向一个特定的目的主机发出的询问，收到此报文的主机必须给源主机发送ICMP回送回答报文。


- 网际组管理协议 **IGMP**（Internet Group Manage Protocol）

##### b. IP分类

IP地址是给因特网上的每一个主机（或路由器）的每一个接口分配一个在全世界唯一的**32位**的标识符。

```properties
IP地址 = <网络号>,<主机号>
```

![IP分类](/Users/dante/Documents/Technique/且行且记/网络/IP分类.png)



- 分组转发算法

  - 从数据报的首部提取目的主机的IP地址 D，从而获取网络地址 N。
  - 若 N 与此路由器直连，则进行直接交付。否则，间接交付。
  - 若路由表中有目标地址为D的特定路由，则数据发送到路由表中指明的下一跳路由器。否则，下一步。
  - 若路由表中有一个默认路由，则把数据报传送到默认路由器。否则，转发分组错误。

- 子网寻址（划分子网）

  - 将IP地址变成三级结构，只把IP地址的主机号部分进行划分，不改变原来的网络号。

    ```properties
    IP地址 = <网络号>,<子网号>,<主机号>
    ```

  - 子网掩码

    用来计算子网地址的掩码，计算方式 IP 和 子网掩码 逐位相“与”。

    ```properties
    例如：IP是 141.14.72.24，子网掩码是 255.255.192.0，计算出网络地址。

    IP二进制 = 10001101 00001110 01001000 00011000
    子网掩码 = 11111111 11111111 11000000 00000000

    逐位相与 = 10001101 00001110 01000000 00000000
    计算结果 = 141.14.64.0
    ```

  - 分组转发

    目的网络地址 + 子网掩码 + 下一跳地址

##### c. 无分类编址 CIDR

```properties
IP地址 = <网络前缀> , <主机号>/<网络前缀的位数>
```

- CIDR 地址块：网络地址前缀相同的连续的IP地址组成一个 “CIDR 地址块”。

```properties
128.14.35.7/20 = 10000000000011100010 0011 00000111
最大、小地址
10000000000011100010 0000 00000000  =  128.14.32.0
10000000000011100010 1111 11111111  =  128.14.47.255

简写
10.0.0.0/10 简写为 10/10
```

- 分组转发：网络前缀 + 下一跳地址，选择具有最长网络前缀的路由。

##### d. 路由选择协议

因特网将整个互联网划分为许多个较小的**自治系统**（autonomous system），即 **AS**。

- 内部网关协议 IGP ，在一个自治系统内部使用的路由选择协议，例如 **RIP 和 OSPF 协议**。

  - RIP

    分布式的基于距离向量的路由选择协议，按固定的时间间隔与相邻路由器交换信息。交换的信息是自己当前的路由表，即到达本**AS**系统中所有网络的最短距离，以及到每一个网络应经过的下一跳路由器。

  - OSPF

    分布式链路状态协议，只在链路状态发生时，才向 AS 中的所有路由器发送链路状态信息。所有的路由器最终都能建立一个全网的拓扑结构图。

- 外部网关协议 EGP，源主机和目标主机处在不同的自治系统中的路由选择协议，例如 **BGP**。

##### e. VPN

在公用网络上建立专用网络，进行加密通讯。一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的VPN系统都知道其他场所的地址。

##### f. 网络地址转换 NAT

​	专有网内的本地IP，要和因特网上的主机进行通信，需要在专有网连接到因特网的路由器上安装 **NAT** 软件（NAT路由器），他至少具有一个全球唯一的外部IP。所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将本地地址转化为全球IP地址。

![NAT路由器](/Users/dante/Documents/Technique/且行且记/网络/NAT路由器.png)

​	NAT路由器如何将目的IP转化成专用网内的哪一个本地IP，通过网络地址和端口号转换。

![NAPT](/Users/dante/Documents/Technique/且行且记/网络/NAPT.png)

#### 4. 运输层

运输层提供的是应用进程间的逻辑通信，并不是真正在两个运输层之间直接传递数据。具有复用和分用的功能。屏蔽了下层网络层的细节。通过协议端口号(Protocol port number) 确定具体的应用进程，16位（2个字节）。

- 复用：在发送方不同的应用进程都可以使用同一个运输层协议传送数据。
- 分用：接收方的运输层在剥去报文的首部后能够把这些数据正确的交付目的应用进程。

##### a. 用户数据报协议 UDP

![UDP协议](/Users/dante/Documents/Technique/且行且记/网络/UDP协议.png)

UDP在IP数据报的基础上添加了复用和分用的功能。主要特点

- 无连接。

- 尽最大努力交付。

- 面向报文的。对于应用层的报文，添加首部后就直接交付**IP**层。

  ![UDP-2](/Users/dante/Documents/Technique/且行且记/网络/UDP-2.png)

- UDP没有阻塞控制，网络阻塞不会使源主机的发送速率降低。IP电话会中断，但不会延迟。

- 支持一对一、一对多、多对一和多对多的交互通信。

- 首部开销小，只有8个字节。TCP有20个字节。首部由四个字段组成，每个字段2个字节。

  - 源端口：在需要对方回信时选用。不需要时为0。
  - 目标端口：在终点交付报文时必须使用。
  - 长度：UDP报文的长度，最小值只有8，即仅有首部。
  - 检验和：检测UDP在传输时是否有错。

##### b. 传输控制协议 TCP

![IP协议](/Users/dante/Documents/Technique/且行且记/网络/IP协议.png)

TCP 协议是**面向连接的**、**端对端的**（endpoint to endpoint）、**提供可靠交付**、**全双工通信**并且**面向字节流**的协议。

- 面向连接

  ​	应用程序在每一次使用TCP协议前，必须先建立 TCP 连接，当数据传输完毕后，释放已建立的连接。整个过程分为三个阶段。

  - 连接端点（endpoint），叫做套接字 Socket，即 **Socket =（IP地址:端口号）**。

    **TCP连接 = (socket1, socket2) ==> (ip1:port1, ip2:port2)**。


  - 建立连接

    ![TCP三次握手](/Users/dante/Documents/Technique/且行且记/网络/TCP三次握手.png)

    **传输控制块**：TCP模块中有一个TCB（传输控制模块，Transmit **Control** Block），它用于记录tcp协议运行过程中的变量。对于有多个连接的tcp，每个连接都有一个tcb。tcb结构的定义包括这个连接使用 的[源端口](https://baike.baidu.com/item/%E6%BA%90%E7%AB%AF%E5%8F%A3)、目的端口、目的ip、序号、应答序号、对方窗口大小、己方窗口大小、tcp状态、top输入/输出[队列](https://baike.baidu.com/item/%E9%98%9F%E5%88%97)、[应用层](https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E5%B1%82)输出队列、tcp的重传有关变量。

    **三次握手**

    1. 客户A向B发送报文请求，TCP首部 SYN=1，携带一个初始序号 seq=x。此时 SYN=1 情况下，不能携带数据，但消耗一个序号。当前 TCP client 进程的状态 SYN-SENT（同步已发送）。（第一次握手）
    2. 服务器B收到请求，同意建立连接，向A发送确认，确认报文 SYC=1，ACK=1，确认号是 ack=x+1，并携带一个初始序号 seq=y，不能携带数据，但消耗一个序号。当前 TCP 服务进程的状态是 SYN-RCVD（同步已接收）。（第二次握手）
    3. TCP Client 进程收到 B 的确认后，再次向 B 发送确认。ACK=1，确认号是 ack=y+1，序号 seq=x+1。（可携带数据，也可不携带【不消耗序号，下一个序号仍是 seq=x+1】），A 进入 ESTABLISHED 状态。B收到确认后也进入 ESTABLISHED 状态。（第三次握手）

  - 释放连接（四次握手）

    ![TCP释放连接](/Users/dante/Documents/Technique/且行且记/网络/TCP释放连接.png)

    1）客户端A发送一个FIN，用来关闭客户A到服务器B的数据发送。

    2）服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。

    3）服务器B关闭与客户端A的连接，发送一个FIN给客户端A。

    4）客户端A发回ACK报文确认，并将确认序号设置为收到序号加1。


 - TCP 状态机

   ![TCP 状态机](/Users/dante/Documents/Technique/且行且记/网络/TCP 状态机.png)

   - 方框：TCP状态。
   - 箭头：状态变迁。
   - 箭头旁边的字：1.引起状态变迁的原因。2.发生状态变迁后出现的动作。
   - 粗实线箭头：客户进程的正常变迁。
   - 粗虚线箭头：服务器进程的正常变迁。
   - 细线箭头：异常变迁。

- 全双工通信：TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有**发送缓存**和**接收缓存**，用来临时存放双方通信的数据。

- 面向字节流：流入到进程或从进程流出的字节序列。一个TCP报文段包含很多的字节序列。

- TCP报文段首部信息

  ![TCP报文段的首部格式](/Users/dante/Documents/Technique/且行且记/网络/TCP报文段的首部格式.png)

  - 源端口和目标端口：各占2个字节。

  - 序号 seq

    ​	占4个字节，共2^32个序号，即4294967296个序号。当序号到达 **2^32 - 1** 后，下一个序号为0。也称为 “报文段序号”，是所发送的数据的第一个字节的序号。

    ```properties
    seq=301，len(data)=100, 下一次seq=401
    ```

  - 确认号 ack

    占4个字节，是期望收到对方下一个报文段的第一个数据字节的序号。确认号N表明，N-1的所有数据都已经正确收到。

    ```properties
    数据长度 100
    A -> B --> seq = 201
    B ack  --> ack = seq + len(data) = 301
    ```

  - 数据偏移

    占4位，TCP报文段中，首部的长度。即，**数据**起始位置 到 **报文**起始位置 的距离。

  - 保留

    占6位，为日后使用，目前都是0。

  - 控制位6个

    - URG，数据指针紧急程序，1最高。
    - ACK，当ACK=0，ack 无效，ACK=1时，有效。建立连接后所有发送的报文段必须设置ACK=1。
    - SYN，SYN=1 表示一个连接请求报文（SYN=1，ACK=0） 或 一个连接接收报文（SYN=1，ACK=1）。
    - FIN，用来释放一个连接。FIN=1，报文段的放送方数据已经发送完毕，并要求释放连接。
    - RST，复位。RST=1，TCP连接中出现差错，必须释放连接，然后重新建立运输连接。
    - 窗口，也叫接收窗口，放送方允许对方发送的数据量（自己的接收能力）。是接收方让发送方设置其发送窗口的依据。

    ```properties
    ack=701, window=1000 --> 放送方从701号起，还能接收1000个字节数据的接收缓存空间。
    ```

- 传输原理

  ​	IP层的传输是尽最大努力交付的，那么就无法保证可靠传输。而 TCP 协议会通过适当的措施使得两个运输层之间的通信变得可靠。

  - 停止等待协议

     每发送完一个分组就停止发送，等待对方的确认。此协议简单，但信道利用率太低。

  - 超时重传

    发送方在发送分组后，超过一定的时间没有收到确认，因此需要重新发送分组。具体实现是在每发送完一个分组设置一个**超时计时器。**超过计时器没有收到确认，就重传；收到确认，清楚计时器。

    - 每次发送后，暂存发送的副本。
    - 分组的发送和确认都必须进行编号。为了定位具体的分组。
    - 超时计时器设置的时间应该比 RTT 时间长，因为网络的不确定性。

  - 流水线传输

    为了提高传输效率，发送方可连续发送多个分组，不必每发完一个分组就停止发送等待接收方的确认。

    ![流水线传输](/Users/dante/Documents/Technique/且行且记/网络/流水线传输.png)

    主要使用的协议有

    - 连续ARQ协议

      ​	发送方维持一份发送窗口（每个窗口中有多个按序号连续的分组），窗口内的分组可以连续发送，不需要等待接收方的确认。

      ​	接收方采用**累积确认**的方式。在收到几个分组后，对按序到达的最后一个分组发送确认。表示：到这个分组为止的所有分组都已经正确的收到了。

      ![连续ARQ协议](/Users/dante/Documents/Technique/且行且记/网络/连续ARQ协议.png)

    - 滑动窗口协议

      滑动窗口以字节为单位，主要依据 **确认号ack**  和 **窗口**。

      ![滑动窗口](/Users/dante/Documents/Technique/且行且记/网络/滑动窗口.png)

      ![滑动窗口-2](/Users/dante/Documents/Technique/且行且记/网络/滑动窗口-2.png)

      ```properties
      A 收到 B 的确认， ack=31，窗口=20

      1. 为收到B确认，A连续发送窗口的数据，但要缓存，为了超时重传。
      2. 由于网络损耗，A的发送窗口应该要 <= B的接收窗口。
      3. 不按序到达的数据，先临时存放到接收窗口中，等为接收的字节流收到后，再按序交付。
      ```

    - 流量控制

      让发送方的发送速率不要太快，使接收方来的及接收。**发送窗口 <= 接收窗口**。

    - 拥塞控制

      ​	在某段时间内，对网络上某个资源的的需求超过了该资源所能提供的可用部分时，网络的性能下降，出现**拥塞**，整个网络的吞吐量下降。当 **吞吐量=0** 时，网络无法工作，成为 **死锁。**

      **拥塞控制**：防止过多的数据进入网络，使路由器或链路不致过载。是全局性的控制。

#### 5. 应用层

​	每个应用层协议都是为了解决某一类具体的问题，问题的解决要通过位于不同主机上的多个应用进程之间的通信和协同工作来完成。应用层的具体内容就是精确的定义这些通信规则（协议）。应用层的许多协议都是基于Client-Server方式的。Client 是服务的请求方，Server 是服务的接收方。

##### a. DNS

域名解析系统，一个联机分布式数据库系统。将主机的名字解析成IP地址。

![域名分类](/Users/dante/Documents/Technique/且行且记/网络/域名分类.png)

​	

DNS域名服务器的分布结构是呈树状分布的。

![树状DNS服务器](/Users/dante/Documents/Technique/且行且记/网络/树状DNS服务器.png)

域名的解析过程

- 主机向本地DNS服务器的查询一般都采用递归查询。
- 本地DNS服务器向根DNS服务器查询一般采用迭代查询。

![域名解析过程](/Users/dante/Documents/Technique/且行且记/网络/域名解析过程.png)

- 具体步骤

![DNS查询步骤](/Users/dante/Documents/Technique/且行且记/网络/DNS查询步骤.png)

- 高速缓存DNS，存放最近查询过的域名以及从何处获取域名映射的记录。

##### b. FTP

文件传输协议。提供交互式的访问，允许客户指明文件的类型和格式，允许文件具有访问权限（认证）。

- 工作原理

  一个FTP服务器进程分为两大部分。

  - 主进程：一个进程，负责接收新的请求。工作步骤如下

    1. 打开**21端口**。
    2. 等待Client请求连接。
    3. 启动从属进程来处理Client的请求。从属进程处理完毕后就终止。
    4. 回到等待状态。

  - 从属进程：多个进程，负责处理单个请求，并发的。文件传输时，建立两个 TCP 连接，**控制连接 和 数据连接**。

    ![FTP工作原理](/Users/dante/Documents/Technique/且行且记/网络/FTP工作原理.png)

##### c. TELNET

远程终端协议，或终端仿真协议。使用 telnet 可以通过 TCP 连接注册到远程主机。

##### d. 万维网 www

简称 web，是一个大规模的、联机式的信息存储所。即，分布式的超媒体系统，是超文本的扩展。其中，超文本指的是包含指向其他文档的链接的文本。

主要包含：

- URL，统一资源定位符。**<协议>://<主机>:<端口>/<路径>**。
- HTTP协议，超文本传输协议。
- HTML。

![WWW的工作过程](/Users/dante/Documents/Technique/且行且记/网络/WWW的工作过程.png)

- 代理服务器

  WWW的高速缓存。将最近的一些请求和响应暂存在本地磁盘。加快访问速度。

  ![WWW代理服务器](/Users/dante/Documents/Technique/且行且记/网络/WWW代理服务器.png)

##### e. DHCP

动态主机配置协议（Dyna Host Config Protocol），Client - Server。对与 Server 的固定位置的计算机指派一个永久的地址（IP地址），机器重启后地址不变。

![DHCP](/Users/dante/Documents/Technique/且行且记/网络/DHCP.png)

1. 主机A启动时，向**DHCP中继代理**服务器广播发送报文。数据报中源地址都是0，目标地址都是1。
2. **DHCP中继代理**服务器将报文以单播的方式转发到 DHCP服务器，等待答复。
3. DHCP服务器分配给DHCP客户的IP地址是临时的，租用期（lease period）有DHCP服务器决定。





### 五. 参考资料

- 网络编程：https://blog.csdn.net/maydaysar/article/details/58204104