## 主从配置

### 一. 概述

MySQL主从复制的原理是指数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，数据的更新可以在远程连接上进行，从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。

MySQL主从复制涉及到三个线程，一个运行在主节点（log dump thread），其余两个（I/O thread, SQL thread）运行在从节点。具体的流程如下：

- 主节点将数据的改变记录到二进制日志（binlog）中，当主节点上的数据发生改变时，则将其改变写入二进制日志中；
- 从节点发起连接，连接到主节点，并请求获取二进制日志的内容；
- 主节点为每个从节点启动一个dump线程，用于向其发送二进制事件，并保存至从节点本地的中继日志（relay log）中；
- 从节点启动一个I/O线程，读取主节点传过来的二进制事件并写入到本地的relay log文件中；
- 从节点启动一个SQL线程，从relay log文件中读取二进制事件，并解析成SQL语句，在本地重放，使得其数据和主节点的保持一致。

### 二. 操作

本次使用`Docker`进行演示，操作系统：MacOS，MySQL 版本是 5.7.37，一主两从。

端口：Master 3316	Slave1 3317	Slave2 3318

#### 1. 主库

（1）配置`my.cnf`

```ini
[mysqld]
log-bin=mysql-bin # 开启二进制日志
server-id=100			# 设置server-id
```

（2）启动容器

```sh
docker run -d \
	--name dante-mysql5-master \
	-p 3316:3306 \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master/data:/var/lib/mysql \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master/conf:/etc/mysql/conf.d \
	-e MYSQL_ROOT_PASSWORD=iamdante \
	mysql:5.7.37
```

（3）为从库创建用户

```sql
use mysql;

create user 'slave1'@'%' identified BY 'iamdante';
create user 'slave2'@'%' identified BY 'iamdante';

grant replication slave on *.* to 'slave1'@'%';
grant replication slave on *.* to 'slave2'@'%';

flush privileges;
```

（4）查看主库状态,日志文件名,日志位置

```sql
show master status;

+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |     1329 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
```

#### 2. 从库

（1）配置`my.cnf`

```ini
## slave1
[mysqld]
server-id=110

## slave2
[mysqld]
server-id=120
```

（2）启动容器

```sh
docker run -d \
	--name dante-mysql5-slave1 \
	-p 3317:3306 \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/slave1/data:/var/lib/mysql \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/slave1/conf:/etc/mysql/conf.d \
	-e MYSQL_ROOT_PASSWORD=iamdante \
	mysql:5.7.37
	
docker run -d \
	--name dante-mysql5-slave2 \
	-p 3318:3306 \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/slave2/data:/var/lib/mysql \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/slave2/conf:/etc/mysql/conf.d \
	-e MYSQL_ROOT_PASSWORD=iamdante \
	mysql:5.7.37
```

（3）执行同步SQL

```sql
-- slave1
use mysql;
change master to master_host='docker.for.mac.host.internal', master_port=3316, master_user='slave1', master_password='iamdante', master_log_file='mysql-bin.000001', master_log_pos=1329;
-- 开启从库模式 
start slave;
-- 查看从库状态
show slave status\G;

-- slave2
use mysql;
change master to master_host='docker.for.mac.host.internal', master_port=3316, master_user='slave2', master_password='iamdante', master_log_file='mysql-bin.000001', master_log_pos=1329;
-- 开启从库模式 
start slave;
-- 查看从库状态
show slave status\G;
```

#### 3. 状态监测

- 主库

```sql
-- 显示 master 复制状态 
show master status; 
-- 显示 Master 库 bin log 情况，跟 show binary logs; 命令一样
show master logs;
-- 查看 MySQL进程状态，包括复制进程，看 state 字段说明
show processlist;
```

- 从库

```sql
-- 查看 MySQL进程状态，包括复制进程，看 state 字段说明 
show processlist;
-- 显示 Slave复制状态，状态很多，具体要查看手册另外是直接查看主从复制的库和表里的数据，是否有及时正常复制过来。
1、Slave_IO_State IO 进程处理状态
2、Slave_IO_Running IO 线程是否打开：YES/NO/NULL三种状态
3、Slave_SQL_Running SQL 线程是否运行：YES/NO/NULL三种状态
4、Seconds_Behind_Master 落后主库的时间（秒）
show slave status;
```

### 三. 调优

从库的配置参数没有一个固定的标准，需要根据主从复制的模式、延迟要求、数据一致性等因素进行调整。一般来说，以下是一些常见的从库配置参数和建议的值：

- server_id：从库的唯一标识，必须和主库不同，可以根据 IP 地址或其他规则来设置。
- read_only：从库是否只允许读操作，建议设置为 ON，以防止从库上的误操作或攻击。
- log_bin：从库是否开启二进制日志，如果从库也作为其他从库的主库，需要设置为 ON，并指定日志文件的位置和名称。
- log_slave_updates：从库是否将复制的事件也记录到自己的二进制日志中，如果从库也作为其他从库的主库，需要设置为 ON。
- sync_binlog：从库将二进制日志缓冲区刷新到磁盘的频率，如果要求数据安全性高，可以设置为 1，每次事务提交都刷新；如果要求性能高，可以设置为 0 或较大的值，让 MySQL 自己控制刷新频率。
- innodb_flush_log_at_trx_commit：从库将事务日志缓冲区刷新到磁盘的频率，如果要求数据安全性高，可以设置为 1，每次事务提交都刷新；如果要求性能高，可以设置为 0 或 2，让 MySQL 自己控制刷新频率或每秒刷新一次。
- slave_parallel_type：从库使用并行复制的方式，可以设置为 DATABASE 或 LOGICAL_CLOCK。DATABASE 模式下，一个 SQL 线程处理一个数据库的更新；LOGICAL_CLOCK 模式下，多个 SQL 线程根据逻辑时钟来分配和处理更新事件。
- slave_parallel_workers：从库使用并行复制的 SQL 线程数，可以根据从库的 CPU 核心数和负载情况来设置，一般不超过 16。

### 四. 双机热备

双机热备，即主主同步。本次使用`Docker`进行演示，操作系统：MacOS，MySQL 版本是 5.7.37，主主同步。

端口：Master1 3326	Slave1 3336

#### 1. 配置

**master1**

```ini
[client]
default-character-set = utf8mb4

[mysqld]
server-id=111
log-bin=mysql-bin
## 设置不需要写 bin 日志的数据库，多个数据库则要多行分别设置 
binlog-ignore-db=mysql 
binlog-ignore-db=information_schema 
binlog-ignore-db=performance_schema
## 设置需要写 bin 日志的数据库，多个数据库则要多行分别设置 
binlog-do-db=demo
log-slave-updates=ON
sync_binlog=1
## auto_increment，控制自增列AUTO_INCREMENT的行为，用于MASTER-MASTER之间的复制，防止出现重复值,
## n有多少台服务器，n就设置为多少, 步长设置为1,这样Master的auto_increment字段产生的数值是:1, 3, 5, 7, …等奇数ID
auto_increment_offset=1
auto_increment_increment=2
replicate-do-db=demo
replicate-ignore-db=mysql,information_schema,performance_schema

character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
lower_case_table_names = 1
default-time-zone = '+08:00'
default_authentication_plugin=mysql_native_password
max_allowed_packet = 256M
innodb_log_file_size = 2G
```

**master2**

```ini
[client]
default-character-set = utf8mb4

[mysqld]
server-id=222
log-bin=mysql-bin
## 设置不需要写 bin 日志的数据库，多个数据库则要多行分别设置 
binlog-ignore-db=mysql 
binlog-ignore-db=information_schema 
binlog-ignore-db=performance_schema
## 设置需要写 bin 日志的数据库，多个数据库则要多行分别设置 
binlog-do-db=demo
log-slave-updates=ON
sync_binlog=1
## auto_increment，控制自增列AUTO_INCREMENT的行为，用于MASTER-MASTER之间的复制，防止出现重复值,
## n有多少台服务器，n就设置为多少, 步长设置为2,这样Master的auto_increment字段产生的数值是:2, 4, 6, 8, …等偶数ID
auto_increment_offset=2
auto_increment_increment=2
replicate-do-db=demo
replicate-ignore-db=mysql,information_schema,performance_schema

character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
lower_case_table_names = 1
default-time-zone = '+08:00'
default_authentication_plugin=mysql_native_password
max_allowed_packet = 256M
innodb_log_file_size = 2G
```

#### 2. 启动数据库

```sh
docker run -d \
	--name dante-mysql5-master1 \
	-p 3326:3306 \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master1/data:/var/lib/mysql \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master1/conf:/etc/mysql/conf.d \
	-e MYSQL_ROOT_PASSWORD=iamdante \
	mysql:5.7.37
	
docker run -d \
	--name dante-mysql5-master2 \
	-p 3336:3306 \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master2/data:/var/lib/mysql \
	-v /Users/dante/Documents/Technique/Docker/volume/mysql5/master2/conf:/etc/mysql/conf.d \
	-e MYSQL_ROOT_PASSWORD=iamdante \
	mysql:5.7.37
```

#### 3. 执行同步命令

```sql
-- master1
use mysql;
-- 查看 master 状态
show master status;
+------------------+----------+--------------+---------------------------------------------+---------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB                          | Executed_Gtid_Set 
+------------------+----------+--------------+---------------------------------------------+---------------+
| mysql-bin.000003 |      154 | demo         | mysql,information_schema,performance_schema |                   
+------------------+----------+--------------+---------------------------------------------+---------------+

-- master2
use mysql;
+------------------+----------+--------------+---------------------------------------------+---------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB                          | Executed_Gtid_Set 
+------------------+----------+--------------+---------------------------------------------+---------------+
| mysql-bin.000003 |      154 | demo         | mysql,information_schema,performance_schema |                   
+------------------+----------+--------------+---------------------------------------------+---------------+

-- 创建用于同步的用户
create user 'backuper'@'%' identified BY 'iamdante';
grant replication slave on *.* to 'backuper'@'%';
flush privileges;

-- 同步设置
stop slave;

-- master1
change master to master_host='docker.for.mac.host.internal', master_port=3336, master_user='backuper', master_password='iamdante', master_log_file='mysql-bin.000003', master_log_pos=154;
start slave;
show slave status\G;

-- master2
change master to master_host='docker.for.mac.host.internal', master_port=3326, master_user='backuper', master_password='iamdante', master_log_file='mysql-bin.000003', master_log_pos=154;
start slave;
show slave status\G;
```

#### 4. 补充

如果【主服务器】重启mysql服务，【从服务器】会等待与【主服务器】重连。当主服务器恢复正常后，从服务器会自动重新连接上主服务器，并正常同步数据。
如果某段时间内，【从数据库】服务器异常导致同步中断（可能是同步点位置不匹配），可以尝试以下恢复方法：进入【主数据库】服务器（正常），在bin-log中找到【从数据库】出错前的position，然后在【从数据库】上执行change master，将master_log_file和master_log_pos重新指定后，开始同步。 

#### 5. 设置VIP

用KeepAlived提供虚拟IP，通过KeepAlived来进行故障监控，实现MySQL故障时自动切换。

主库1（192.168.1.130）、主库1（192.168.1.130）、VIP（192.168.1.55）

MySQL 的端口必须保持一致

- **主库1**

```ini
global_defs {
  default_interface MYSQL_HA
}

vrrp_instance VI_1 {
  interface eth0

  state BACKUP
  virtual_router_id 51
  priority 150
  acvert_int 1
  nopreempt

  virtual_ipaddress {
    192.168.1.55
  }

  authentication {
    auth_type PASS
    auth_pass keepalived123
  }

}

virtual_server 192.168.1.55 33306 {
    delay_loop 2     # 每个2秒检查一次real_server状态
    lb_algo wrr      # LVS调度算法,rr|wrr|lc|wlc|lblc|sh|dh
    lb_kind DR       # LVS集群模式 ,NAT|DR|TUN
    persistence_timeout 60    # 会话保持时间
    protocol TCP 
    real_server 192.168.1.130 33306 {
        weight 3   # 权重
        notify_down   /container/service/keepalived/mysql.sh    # 检测到服务down后执行的脚本
        TCP_CHECK {
            connect_timeout 10   # 连接超时时间
            nb_get_retry 3      # 重连次数
            delay_before_retry 3 # 重连间隔时间
            connect_port 3326    # 健康检查端口
        }
    }
}
```

- **主库2**

```ini
global_defs {
  default_interface MYSQL_HA
}

vrrp_instance VI_1 {
  interface eth0

  state BACKUP
  virtual_router_id 51
  priority 120
  acvert_int 1
  nopreempt

  virtual_ipaddress {
    192.168.1.55
  }

  authentication {
    auth_type PASS
    auth_pass keepalived123
  }

}

virtual_server 192.168.1.55 33306 {
    delay_loop 2     # 每个2秒检查一次real_server状态
    lb_algo wrr      # LVS调度算法,rr|wrr|lc|wlc|lblc|sh|dh
    lb_kind DR       # LVS集群模式 ,NAT|DR|TUN
    persistence_timeout 60    # 会话保持时间
    protocol TCP 
    real_server 192.168.1.130 33306 {
        weight 3   # 权重
        notify_down   /container/service/keepalived/mysql.sh    # 检测到服务down后执行的脚本
        TCP_CHECK {
            connect_timeout 10   # 连接超时时间
            nb_get_retry 3      # 重连次数
            delay_before_retry 3 # 重连间隔时间
            connect_port 3326    # 健康检查端口
        }
    }
}
```

- **mysql.sh**

```sh
#!/bin/sh

killall keepalived
```

- **启动**

```bash
docker run -d --name dante-keepalived \
	-p 13306:13306 \
	-v ~/Documents/Technique/Docker/volume/mysql5/keepalived/keepalived.conf:/container/service/keepalived/assets/keepalived.conf \
	-v ~/Documents/Technique/Docker/volume/mysql5/keepalived/mysql.sh:/container/service/keepalived/mysql.sh \
	osixia/keepalived:2.0.20 --copy-service
```

### 五. 备份还原

 - mysqldump

  中小型数据库，20G以内

 - xtrabackup

   大型数据库，Percona XtraBackup 工具

 - Navicat工具备份

  优缺点：使用方便，但是备份和还原时间都比较长

**参考资料：**

- https://zhuanlan.zhihu.com/p/143899576
- https://www.modb.pro/db/99260

### 六. 参考资料

- https://laravelacademy.org/post/20020
- https://blog.csdn.net/weixin_40461281/article/details/90711714
- https://blog.csdn.net/xlgen157387/article/details/51331244/
- https://blog.csdn.net/weixin_40461281/article/details/90711714
- https://www.modb.pro/db/74069
- https://blog.csdn.net/xuejiazhi/article/details/8941156
- https://www.open-open.com/lib/view/open1449149209405.html （*）
