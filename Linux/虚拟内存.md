## 虚拟内存

### 一. 概念

Swap分区是一块特殊的硬盘空间，它的作用是当实际内存不够用的时候，操作系统会从内存中取出一部分暂时不用的数据，放在Swap分区中，从而为当前运行的程序腾出足够的内存空间。

### 二. 优缺点

Swap分区的优点是可以在物理内存不够用的时候，为当前运行的程序提供额外的内存空间，从而提高系统的稳定性和性能。Swap分区也可以支持系统的休眠功能，将内存中的数据保存到Swap分区上，加快系统的启动速度。

Swap分区的缺点是它是存放在磁盘上的，磁盘的速度远远低于内存，如果频繁地读写Swap分区，会降低系统的运行速度，甚至导致系统几乎死机。Swap分区也可能影响一些桌面程序的响应速度，因为最小化后的程序可能被移动到Swap分区上，再打开时需要重新加载到内存中

### 三. Swap分区的大小

Swap分区的大小没有一个固定的标准，一般来说，它取决于系统的物理内存大小、业务的内存负荷、是否需要休眠功能等因素。常见的建议是：

- 当物理内存小于1G且不需要休眠时，设置和内存同样大小的Swap空间即可；当需要休眠时，建议配置两倍物理内存的大小，但最大值不要超过两倍内存大小。
- 当物理内存大于1G且不需要休眠时，建议大小为round (sqrt (RAM))，其中RAM为物理内存大小；当需要休眠时，建议大小是RAM+round (sqrt (RAM))，但最大值不要超过两倍内存大小。
- 当物理内存在4G以内时，Swap设置为内存的2倍，不超过4G
- 当物理内存在4-8G时，Swap等于内存大小
- 当物理内存在8-64G时，Swap设置为8G
- 当物理内存在64-256G时，Swap设置为16G

另外，还可以根据系统的实际情况，调整swappiness参数，来控制系统对Swap分区的使用频率。swappiness的值越大，表示越积极使用Swap分区，越小表示越积极使用物理内存。默认值swappiness=60，在CentOS 7上是30。可以通过sysctl命令或者修改/etc/sysctl.conf文件来调整这个参数。

### 四. 如何创建

创建Swap分区的方式有两种：使用分区创建Swap；使用文件创建Swap**（推荐）**。

**使用文件创建Swap**

#### 1. dd 命令创建swap文件

```sh
dd if=/dev/zero of=/data/swap/swapfile bs=1M count=8192

# if：从哪取
# of：取到哪
# bs：块大小
# count：共取多少（1*8192=8192M=8G）
```

#### 2. 使用mkswap格式化

```sh
mkswap /data/swap/swapfile
```

#### 3. 使用swapon启用

```sh
swapon /data/swap/swapfile

## 可能会有提示 swapon: /data/swap/swapfile: insecure permissions 0644, 0600 suggested.
## 执行：chmod 0644 /data/swap/swapfile
```

#### 4. 设置开机启动

```sh
## 在文件/etc/fstab中添加一行
/data/swap/swapfile 	swap 	swap 	defaults 	0 0
```

#### 5. 监控Swap

```sh
## 1. 使用free命令查看Swap分区的总大小、已用大小和空闲大小，以及Swap分区占用物理内存的百分比
free -h

## 2. 使用swapon命令查看当前系统中所有已经启用的Swap分区的详细信息，包括分区名称、类型、大小、使用情况等。
swapon -s

## 3. 使用top命令查看系统的CPU、内存、Swap、进程的使用情况，其中第三行显示了Swap分区的总量、已用量和空闲量
top

## 4. 使用vmstat命令查看系统的虚拟内存统计信息，其中si和so列显示了每秒从Swap分区读入和写出的数据量，这些数据反映了系统对Swap分区的读写频率。例如：vmstat 1 10可以每隔1秒显示一次虚拟内存信息，共显示10次。
vmstat 1 10
```

### 五. 参考资料

- http://c.biancheng.net/view/907.html
- https://blog.csdn.net/sirchenhua/article/details/87861709